---
import { updateCategory } from '@/api/categories/mutations';
import { getCategoryById } from '@/api/categories/queries';
import { CategorySchema } from '@/types/categories.types';
import type { ValidationErrors } from '@/types/formValidation.types';
import Layout from '@layouts/Layout.astro';
import { ZodError } from 'zod';
import CategoryForm from '../_components/CategoryForm.astro';
const { id } = Astro.params;
const { user } = Astro.locals;

const [category] = await getCategoryById({
  id: Number(id),
  userId: user.id
});

let validationErrors: ValidationErrors | undefined;

if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();

  try {
    const data = CategorySchema.parse(formData);
    await updateCategory({ ...category, ...data });

    return Astro.redirect('/categories');
  } catch (error) {
    if (error instanceof ZodError) {
      validationErrors = error.flatten().fieldErrors;
    }
    return Astro.redirect('/categories/' + goal.id + '/error');
  }
}
---

<Layout pageName='Category'>
  <CategoryForm validationErrors={validationErrors} category={category} title='Edit Category' />
</Layout>
