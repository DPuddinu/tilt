---
import { createActivity } from '@/api/activities/mutations';
import { createGoal } from '@/api/goals/mutations';
import { setSetupDone } from '@/api/setup/mutations';
import { getSetupDone } from '@/api/setup/queries';
import ActivityForm from '@/components/ActivityForm.astro';
import GoalForm from '@/pages/goals/_components/GoalForm.astro';
import { getStep1, getStep2, setStep1, setStep2, stepsCompleted } from '@/store/first-setup.store';
import type { ValidationErrors } from '@/types/formValidation.types';
import { GoalInsertSchema } from '@/types/goal.types';
import Layout from '@layouts/MainLayout.astro';
import SetupLayout from '@layouts/SetupLayout.astro';
import type { TActivity } from 'db/config';
import { ZodError, z } from 'zod';
import { zfd } from 'zod-form-data';

const { user } = Astro.locals;
if (await getSetupDone(user.id)) return Astro.redirect('/goals');
const step = Astro.url.searchParams.get('step');
if (!step) return Astro.redirect('/setup?step=1');

let validationErrors: ValidationErrors | undefined;

let activities: TActivity[] = [];
const schema = zfd.formData({
  name: zfd.text(z.string().min(3).max(30)),
  color: zfd.text(z.string()),
  icon: zfd.text(z.string())
});

try {
  const step1 = getStep1();
  if (step1) {
    activities = [
      {
        id: -1,
        name: getStep1()!.createActivityPayload.name,
        authorId: user.id,
        color: getStep1()!.createActivityPayload.color,
        icon: getStep1()!.createActivityPayload.icon
      }
    ];
  }
  if (step === '2' && !getStep1()) return Astro.redirect('/setup?step=1');
} catch (error) {
  return Astro.redirect('/error?redirect=setup');
}

if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  if (step === '1') {
    try {
      const validated = schema.parse(formData);
      const startIndex = validated.icon.indexOf('icons/');
      const iconPath = validated.icon.substring(startIndex);
      setStep1({
        authorId: user.id,
        ...validated,
        icon: iconPath
      });

      return Astro.redirect('/setup?step=2');
    } catch (error) {
      if (error instanceof ZodError) {
        validationErrors = error.flatten().fieldErrors;
      }
    }
  }
  if (step === '2') {
    try {
      const data = GoalInsertSchema.parse(formData);
      setStep2({
        ...data,
        authorId: user.id,
        authorName: user.name
      });
    } catch (error) {
      if (error instanceof ZodError) {
        validationErrors = error.flatten().fieldErrors;
      } else return Astro.redirect('/error?redirect=setup');
    }
  }
  try {
    if (stepsCompleted()) {
      const activity = await createActivity({
        authorId: user.id,
        name: getStep1()!.createActivityPayload.name,
        color: getStep1()!.createActivityPayload.color,
        icon: getStep1()!.createActivityPayload.icon
      });
      await createGoal({
        ...getStep2()!.goalInsertPayload,
        activityId: activity.id,
        authorId: user.id,
        authorName: user.name
      });
      await setSetupDone(user.id);
      return Astro.redirect('/goals');
    }
  } catch (error) {
    return Astro.redirect('/error?redirect=setup');
  }
}
---

<Layout>
  <SetupLayout>
    {step === '1' && <ActivityForm validationErrors={validationErrors} />}
    {step === '2' && <GoalForm activities={activities} validationErrors={validationErrors} />}
  </SetupLayout>
</Layout>
