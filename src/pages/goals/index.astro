---
import { getCategories } from '@/api/categories/queries';
import { ITEMS_PER_PAGE, getCompletionRate, getPaginatedGoals } from '@/api/goals/queries';
import GoalFilterSidebar from '@/pages/goals/_components/GoalFilters.astro';
import CategoriesStore from '@/store/categories.store';
import FilterStore from '@/store/filters.store';
import GoalStore from '@/store/goals.store';
import type { GoalFilters, GoalFormParam } from '@/types/filters.types';
import Card from '@components/Card.astro';
import Fab from '@components/Fab.astro';
import GoalsList from '@components/GoalsList.astro';
import Layout from '@layouts/MainLayout.astro';
import type { TCategory, TGoal } from 'db/config';

const { user } = Astro.locals;

function getParam(param: string) {
  return Astro.url.searchParams.get(param);
}

function getGoalParam(param: GoalFormParam) {
  return getParam(param);
}

const goalFilters: GoalFilters = {
  completed: getGoalParam('completed') === 'on' || undefined,
  notCompleted: getGoalParam('notCompleted') === 'on' || undefined,
  expired: getGoalParam('expired') === 'on' || undefined,
  notExpired: getGoalParam('notExpired') === 'on' || undefined,
  fromDate: getGoalParam('fromDate') || undefined,
  toDate: getGoalParam('toDate') || undefined,
  category: Number(getGoalParam('category')) || undefined
};
const offsetFilter = Number(getParam('offset')) || 0;
const currentPage = offsetFilter / ITEMS_PER_PAGE + 1;
let totalRows = 0;
let goals: TGoal[] = [];
let totalPages = 0;
let categories: TCategory[] = [];
let completionRate: number;
let totalGoals: number;
let lastWeekGoals: number;
let delta: number;

FilterStore.checkFilterChange({ goalFilters, onChangedFilters: () => GoalStore.clear() });
FilterStore.setFilters(goalFilters);
FilterStore.setCurrentPage(currentPage);

try {
  const cachedGoalsCount = GoalStore.getGoalsCount();
  const cachedGoals = GoalStore.getGoalsByPage(currentPage);
  const cachedCategories = CategoriesStore.getAll();

  const { getGoals, countGoals } = getPaginatedGoals({
    userId: user.id,
    page: currentPage,
    filters: goalFilters
  });
  if (cachedGoals) {
    goals = cachedGoals;
    totalRows = cachedGoalsCount;
  } else {
    goals = await getGoals;
    totalRows = (await countGoals)?.count ?? 0;
    GoalStore.set(currentPage, ...goals);
    GoalStore.setGoalsCount(totalRows);
  }
  totalPages = Math.ceil(totalRows / ITEMS_PER_PAGE);

  if (cachedCategories) {
    categories = cachedCategories;
  } else {
    categories = await getCategories(user.id);
    CategoriesStore.set(categories);
  }

  const { ratePercentage, lastWeekGoalsCount, lastTwoWeekGoalsCount, totalGoalsCount, deltaCount } =
    await getCompletionRate(user.id);
  completionRate = ratePercentage;
  totalGoals = totalGoalsCount;
  lastWeekGoals = lastWeekGoalsCount;
  delta = deltaCount;
} catch (error) {
  return Astro.redirect('goals/error');
}
---

<Layout pageName='Goals'>
  <section transition:animate='none' class='flex-container'>
    <div class='content flex flex-col gap-4'>
      <GoalFilterSidebar categories={categories} filters={goalFilters} />
      <div class='flex grow flex-col gap-4 md:flex-row'>
        <GoalsList
          title='Goals'
          goals={goals}
          totalRows={totalRows}
          totalPages={totalPages}
          offset={offsetFilter}
          currentPage={currentPage}
          itemsPerPage={ITEMS_PER_PAGE}
        />
        <Card title='Goals Report'>
          <div class='report flex flex-col gap-4 sm:grid sm:grid-cols-4 sm:gap-8'>
            <div>
              <h3 class='text-balance text-4xl sm:text-center'>
                {`${completionRate}%`}
              </h3>
              <p class='text-balance text-base sm:text-center'>completed</p>
            </div>
            <div>
              <h3 class='text-balance text-4xl sm:text-center'>
                {`${totalGoals}`}
              </h3>
              <p class='text-balance text-base sm:text-center'>total goals</p>
            </div>
            <div>
              <h3 class='text-balance text-4xl sm:text-center'>
                {`${lastWeekGoals}`}
              </h3>
              <p class='text-balance text-base sm:text-center'>new goals last week</p>
            </div>
            <div>
              <h3 class='text-balance text-4xl sm:text-center'>
                {`${delta >= 0 ? '+' : '-'}${delta}`}
              </h3>
              <p class='text-balance text-base sm:text-center'>VS previous week</p>
            </div>
          </div>
        </Card>
      </div>
    </div>
  </section>
  <Fab href='/goals/new'>+</Fab>
</Layout>

<style>
  .report {
    container-type: inline-size;
    h3 {
      font-size: clamp(1.5em, 5cqw, 2em);
    }
  }
</style>
