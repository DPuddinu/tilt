---
import { getCompletionRate } from '@/api/goals/queries';
import Card from '@components/Card.astro';
import Layout from '@layouts/MainLayout.astro';

const { user } = Astro.locals;

let completionRate: number;
let totalGoals: number;
let lastWeekGoals: number;
let delta: number;

try {
  const {
    completionRate: ratePercentage,
    lastWeekGoalsCount,
    totalGoalsCount,
    deltaCount
  } = await getCompletionRate(user.id);
  completionRate = ratePercentage;
  totalGoals = totalGoalsCount;
  lastWeekGoals = lastWeekGoalsCount;
  delta = deltaCount;
} catch (error) {
  return Astro.redirect('goals/error');
}
---

<Layout pageName='Report'>
  <Card title='Goals Report' >
    <div class='report flex flex-col gap-4 sm:grid sm:grid-cols-4 sm:gap-8'>
      <div>
        <h3 class='text-balance text-4xl sm:text-center'>
          {`${completionRate}%`}
        </h3>
        <p class='text-balance text-base sm:text-center'>completed</p>
      </div>
      <div>
        <h3 class='text-balance text-4xl sm:text-center'>
          {`${totalGoals}`}
        </h3>
        <p class='text-balance text-base sm:text-center'>total goals</p>
      </div>
      <div>
        <h3 class='text-balance text-4xl sm:text-center'>
          {`${lastWeekGoals}`}
        </h3>
        <p class='text-balance text-base sm:text-center'>new goals last week</p>
      </div>
      <div>
        <h3 class='text-balance text-4xl sm:text-center'>
          {`${delta >= 0 ? '+' : ''}${delta}`}
        </h3>
        <p class='text-balance text-base sm:text-center'>VS previous week</p>
      </div>
    </div>
  </Card>
</Layout>
