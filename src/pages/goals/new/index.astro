---
import { createGoal } from '@/api/goals/mutations';
import type { ValidationErrors } from '@/types/formValidation';
import GoalForm from '@components/GoalForm.astro';
import Layout from '@layouts/Layout.astro';
import { Category, db, eq } from 'astro:db';

const { user } = Astro.locals;
const categories = await db.select().from(Category).where(eq(Category.authorId, user.id));

let validationErrors: ValidationErrors | undefined;
if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();

  const res = await createGoal({
    formData,
    user,
    onSuccess: () => Astro.redirect('/goals'),
    onError: () => Astro.redirect('/goals/error'),
    onValidationError: (errors) => (validationErrors = errors)
  });
  if (res) return res;
}
---

<Layout pageName='New'>
  <GoalForm title='Add New Goal' categories={categories} validationErrors={validationErrors} />
</Layout>
